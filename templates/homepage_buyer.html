<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AngkatAni - Filtered Products</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/homepage_buyer.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
    <body>
 
    <!-- Header -->
    <header class="top-bar">
      <div class="logo">
        <img src="{{ url_for('static', filename='images/logo.png') }}" class="logo-icon"/>
          AngkatAni
      </div>          
      <div class="tagline">Connecting you to Local Farmers</div>
    </header>
 
  
    <!-- Breadcrumb Navigation -->
    <nav class="main-nav">
      <ul class="breadcrumb">
        <li><a href="/homepage_buyer"> <i class="fas fa-home"></i></a></li>
        <li>›</li>
        <li>
          <a href="/homepage_buyer" id="category-link" class="button">
            {% if selected_category == 'all' or not selected_category %}
                All Products
            {% else %}
                {{ selected_category|capitalize }}
            {% endif %}
          </a>
        </li>
      </ul>
   
      <div class="icons">
        <span class="cart">
          <a href="{{ url_for('cart.cart') }}" class="cart-link">
            <i class="fas fa-shopping-cart"></i>
          </a>
        </span>
        <div class="user-dropdown" id="userDropdown">
            <span class="user" id="userIcon"><i class="fas fa-user"></i></span>
            <div class="user-menu" id="userMenu">
              <a href="{{ url_for('buyer_account.buyer_account') }}" class="account-btn">My Account</a>
              <form action="{{ url_for('homepage_buyer.logout') }}" method="post">
                <button class="logout-btn" type="submit">Logout</button>
              </form>
            </div>
        </div>
      </div>
    </nav>
     
    <!-- Main Container -->

      <aside class="sidenav">
        <!--  CATEGORY Section -->
        <div class="category-filter">
          <form id="filterForm" action="{{ url_for('homepage_buyer.filter_products') }}" method="get">
            <div class="location-range">
              <label for="locationRange">Location Range (km):</label>
              <div class="range-wrapper">
                <input type="range" id="locationRange" name="range_km" min="0" max="50" step="1" value="{{ selected_km }}" oninput="this.nextElementSibling.value = this.value">
                <output>{{ selected_km }}</output>
                <button type="submit" class="filter-btn"><i class="fas fa-filter"></i> Filter</button>
              </div>
            </div>
     
          <!-- Categories -->
          <h3>CATEGORIES</h3>
          <!-- 2-column category grid -->
          <div class="category-buttons two-column">
            <!-- All Products (fixed) -->
            <button type="button"
              class="category-item {% if not selected_category or selected_category == 'all' %}active{% endif %}"
              data-category="all">
              <i class="fas fa-th-large"></i> All
            </button>
            {% set icon_map = {
                'Vegetables': 'fas fa-leaf',
                'Fruits': 'fas fa-apple-whole',
                'Dairy': 'fas fa-cheese',
                'Grains': 'fas fa-wheat-awn',
                'Spices': 'fas fa-pepper-hot',
                'Fertilizers': 'fas fa-seedling',
                'Pesticides': 'fas fa-spray-can',
                'Seeds': 'fas fa-clipboard-check'
            } %}
            <!-- Database-driven categories -->
            {% for category in categories %}
            <button type="button"
                class="category-item {% if selected_category == category.Category_Name|lower %}active{% endif %}"
                data-category="{{ category.Category_Name }}">
                <i class="{{ icon_map.get(category.Category_Name, 'fas fa-tag') }}"></i>
                {{ category.Category_Name }}
            </button>
            {% endfor %}
          </div>
          <!-- Hidden field -->
          <input type="hidden" name="category" id="selectedCategory" value="{{ selected_category or 'all' }}">

          <!-- Buyer Menu -->
          <div class="status">
            <h3>BUYER MENU</h3>
            <ul class="status-list">
              <li>
                <form action="/homepage_buyer" method="get">
                  <button type="submit" class="status-item active">
                    <i class="fas fa-home"></i> Homepage
                  </button>
                </form>
              </li>
              <li>
                <form action="{{ url_for('homepage_buyer.to_pay_orders') }}" method="get">
                  <button type="submit" class="status-item"><i class="fas fa-receipt"></i> Orders</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
      </aside>
      

      <div class="main-content">
       <div class="top-content-container">
    <h2>Welcome, {{ username }}!</h2>
    {% if default_address %}
        <p>Default address: {{ default_address.Municipality }}, {{ default_address.Province }}</p>
    {% else %}
        <p>Default address: Not set</p>
    {% endif %}

    <div class="stats-container">
      <div class="stat-box low-stock">
          <h4>AVAILABLE OFFERS</h4>
          <h2>{{ total_products }}</h2>
          <p>Available farm produce</p>
      </div>

      <div class="stat-box in-stock">
        <h4> Showing products within {{ selected_km }} km 
            {% if selected_category == 'all' or not selected_category %}
                (All Categories)
            {% else %}
                ({{ selected_category|capitalize }})
            {% endif %}
        </h4>
        <h2>{{ filtered_count }}</h2>
        <p>Products matching your filters</p>
      </div>
    </div>
  </div>

      <div class="column column-right">
        <h4>PRODUCTS</h4>
        <div class="search-filter-container">
      </div>

      <div class="product-container">
  {% if product_data %}
    {% for product in product_data %}
      <div class="product-box">
        <div class="image-container">
          <a href="{{ url_for('viewproduct.viewproduct', product_id=product['ProductID']) }}">
            <img src="{{ url_for('static', filename='images/products/' + product['ImageFileName']) }}" alt="Product Image">
          </a>
          <div class="in-stock">In Stock</div>
        </div>
        <div class="product-content">
          <h3>{{ product['Product_Name'] }}</h3>

          {% if product['MinPrice'] == product['MaxPrice'] %}
            <p class="price">₱{{ product['MinPrice'] }}</p>
          {% else %}
            <p class="price">₱{{ product['MinPrice'] }} - ₱{{ product['MaxPrice'] }}</p>
          {% endif %}
          <p class="per-unit">per unit</p>

          <div class="location">
  <i class="fas fa-map-marker-alt"></i>
  <div>
    <p>{{ product['Municipality'] }}, {{ product['Province'] }}</p>
    {% if product.Distance is not none %}
      <p>{{ product.Distance }} km away</p>
    {% endif %}
  </div>
</div>
        <a href="{{ url_for('viewproduct.viewproduct', product_id=product['ProductID']) }}" class="view-product">
  <i class="fas fa-eye"></i> View Product
</a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No products available for the selected category.</p>
  {% endif %}
</div>


    <script>
      {% if show_address_alert %}
          Swal.fire({
              icon: 'warning',
              title: 'No Address Found',
              text: 'For the range filter to work correctly, please add an address first!',
              confirmButtonText: 'Add Address'
          }).then((result) => {
              if (result.isConfirmed) {
                  window.location.href = "{{ url_for('buyer_address.buyer_address') }}";
              }
          });
          {% endif %}
   
      document.querySelectorAll('.category-option input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
          this.closest('form').submit();
        });
      });

      document.addEventListener('DOMContentLoaded', function () {
        const userIcon = document.getElementById('userIcon');
        const userMenu = document.getElementById('userMenu');


        userIcon.addEventListener('click', function (event) {
          userMenu.classList.toggle('show');
          event.stopPropagation();
        });

        document.addEventListener('click', function (event) {
          if (!userMenu.contains(event.target)) {
              userMenu.classList.remove('show');
            }
          });
        });

        const slider = document.getElementById('locationRange');
        const outputs = document.querySelectorAll('output');
        const forms = document.querySelectorAll('.category-form');

        slider.addEventListener('input', function() {
            outputs.forEach(o => o.value = this.value);
            forms.forEach(f => {
                const hidden = f.querySelector('input[name="range_km"]');
                hidden.value = this.value;
            });
        });


        document.addEventListener('DOMContentLoaded', function () {
          const categoryButtons = document.querySelectorAll('.category-item');
          const selectedInput = document.getElementById('selectedCategory');


        categoryButtons.forEach(btn => {
            btn.addEventListener('click', function () {


                categoryButtons.forEach(b => b.classList.remove('active'));


                this.classList.add('active');


                selectedInput.value = this.getAttribute('data-category');
            });
        });


        // Slider live output
        const slider = document.getElementById('locationRange');
        const output = slider.nextElementSibling;
        slider.addEventListener('input', function() {
            output.value = this.value;
        });
    });


      // Update breadcrumb link only when filter form is submitted
          const filterForm = document.getElementById('filterForm');
          const categoryLink = document.getElementById('category-link');


          filterForm.addEventListener('submit', function () {
              const category = selectedInput.value || 'all';
              categoryLink.textContent = category === 'all' ? 'All Products' : category;
              categoryLink.href = `/homepage_buyer?category=${encodeURIComponent(category)}`;
          });
</script>

</body>
</html>

