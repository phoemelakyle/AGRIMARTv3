<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AngkatAni - Edit Product</title>
<link rel="stylesheet" type="text/css" href="../static/css/add_product.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/homepage_buyer.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
.variation-card {
    position: relative;
    background-color: #f9fafb;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.variation-card .delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background-color: transparent;
    border: none;
    color: #ef4444;
    font-size: 18px;
    cursor: pointer;
    font-weight: bold;
}
.variation-card .delete-btn:hover { color: #b91c1c; }
.variation-card .grid-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}
@media (min-width: 768px) {
    .variation-card .grid-row { grid-template-columns: repeat(3, 1fr); }
}
.variation-card label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 6px;
    color: #374151;
}
.variation-card input[type="text"],
.variation-card input[type="number"] {
    max-width: 180px;
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 0.875rem;
}
.modal { display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);}
.modal-content { background-color: #fff; margin: 10% auto; padding: 20px; width: 50%; border-radius: 8px;}
.button1 { background-color: #27ae60; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; }
.button1:hover { background-color: #1e8449; }
</style>
</head>
<body>


<header class="top-bar">
    <div class="logo"><img src="/static/images/logo.png" alt="Agrimart Logo" class="logo-icon"> AngkatAni</div>
    <div class="tagline">Connecting you to Local Farmers</div>
</header>


<nav class="main-nav">
    <ul class="breadcrumb">
        <li><a href="/homepage_seller"><i class="fas fa-home"></i></a></li>
        <li>›</li>
        <li>Edit Product</li>
    </ul>
    <div class="icons">
        <div class="user-dropdown" id="userDropdown">
            <span class="user" id="userIcon"><i class="fas fa-user"></i></span>
            <div class="user-menu" id="userMenu">
                <form action="{{ url_for('homepage_seller.logout') }}" method="post">
                    <button class="logout-btn" type="submit">Logout</button>
                </form>
            </div>
        </div>
    </div>
</nav>


<div class="dashboard-container">
        <aside class="sidenav">
            <div class="status">
                <h3>SELLER MENU</h3>
                <ul class="status-list">
                    <li>
                        <form action="/homepage_seller" method="get">
                            <button type="submit" class="status-item">
                                <i class="fas fa-home"></i> Homepage
                            </button>
                        </form>
                    </li>
                    <li>
                        <form action="{{ url_for('seller_orders.unpaid_orders') }}" method="get">
                            <button type="submit" class="status-item">
                                <i class="fas fa-receipt"></i> Orders
                            </button>
                        </form>
                    </li>
                    <li>
                        <button type="button" class="status-item" id="addProductBtn">
                            <i class="fas fa-plus-circle"></i> Add Product
                        </button>
                    </li>
                   <li>
        <form action="/dashboard" method="get">
          <button type="submit" class="status-item">
            <i class="fas fa-tachometer-alt"></i> Dashboard
          </button>
        </form>
      </li>
                </ul>
            </div>
        </aside>




<main class="main-content">
    <div class="product-info">
        <h1>EDIT PRODUCT</h1>
        <form method="post" action="{{ url_for('homepage_seller.edit_product', product_id=product['ProductID']) }}" enctype="multipart/form-data">


            <!-- Product Details -->
            <div class="variation-table">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Weight</th>
                            <th>Packaging L</th>
                            <th>Packaging W</th>
                            <th>Packaging H</th>
                            <th>Shipping Fee</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <div class="image-upload-wrapper">
                                <input type="file" id="image_filename" name="Image" accept="image/*" onchange="previewImage()">
                                <div id="previewContainer">
                                    <img id="imagePreview" src="{{ url_for('static', filename='images/products/' + product['ImageFilename']) }}" style="max-width:100px; max-height:100px;">
                                </div>
                                </div>
                            </td>
                            <td><input type="text" name="product_name" value="{{ product['Product_Name'] }}" required></td>
                            <td><input type="text" name="weight" value="{{ product['Weight'] }}" required></td>
                            <td><input type="text" name="packaging_length" value="{{ product['Packaging_Length'] }}" required></td>
                            <td><input type="text" name="packaging_width" value="{{ product['Packaging_Width'] }}" required></td>
                            <td><input type="text" name="packaging_height" value="{{ product['Packaging_Height'] }}" required></td>
                            <td><input type="text" id="shipping_fee" name="shipping_fee" value="{{ product['Shipping_Fee'] }}" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <!-- Product Address -->
            <div class="variations-section">
                <h2>Product Address</h2>
                {% if address %}
                    <p><strong>{{ address['Street'] }}</strong>, {{ address['Municipality'] }}, {{ address['Province'] }}</p>
                    <p>{{ address['Region'] }}, {{ address['Zip_Code'] }}</p>
                {% else %}
                    <p>No address selected</p>
                {% endif %}
                <button type="button" class="button1" onclick="openAddressModal()">Change Address</button>
            </div>


            <!-- Existing Variations -->
           <div class="variations-section">
    <h2>Existing Variations</h2>
    {% for variation in variations %}
    <div class="variation-card" id="variation-{{ variation['VariationID'] }}">
        <input type="hidden" name="existing_variations[]" value="{{ variation['VariationID'] }}">
        
        <div class="grid-row-wrapper">
            <div class="grid-row">
                <div>
                    <label>Variant (e.g., Color, Type, Family, Size)</label>
                    <input type="text" name="unit[]" value="{{ variation['Unit'] }}" required>
                </div>
                <div>
                    <label>Price</label>
                    <input type="number" name="price[]" value="{{ variation['Price'] }}" required>
                </div>
                <div>
                    <label>Quantity</label>
                    <input type="text" name="quantity[]" value="{{ variation['Quantity'] }}" required>
                </div>
            </div>
            <button type="submit" class="delete-variation-button" name="delete_variation_button_{{ variation['VariationID'] }}">Delete</button>
        </div>

        <input type="hidden" name="delete_variation[]" value="{{ variation['VariationID'] }}">
    </div>
    {% endfor %}
</div>

<style>
.variation-card {
    background-color: #f9fafb;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.grid-row-wrapper {
    display: flex;
    align-items: center; /* Vertically center delete button */
    justify-content: space-between; /* Push delete button to the right */
    gap: 16px;
}

.grid-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    flex: 1; /* Take remaining space */
}

@media (min-width: 768px) {
    .grid-row {
        grid-template-columns: repeat(3, 1fr);
    }
}

.variation-card label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 6px;
    color: #374151;
}

.variation-card input[type="text"],
.variation-card input[type="number"] {
    max-width: 180px;
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 0.875rem;
}

.delete-variation-button {
    background-color: #ef4444; /* red-500 */
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    height: fit-content; /* Adjust height to content */
}

.delete-variation-button:hover {
    background-color: #b91c1c; /* red-700 */
}
</style>

            <!-- New Variations -->
            <div class="variations-section">
                <h2>New Variations</h2>
                <div id="new-variation-container"></div>
                <button type="button" class="button1" onclick="addNewVariation()">Add New Variation</button>
                 <input type="submit" value="Update Product" class="button1">

            </div>
        </div>
        </form>


    </div>
</main>
</div>


<!-- Address Modal -->
<div id="addressModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Select New Address</h3>
        <div id="addressList"></div>
       
    </div>
</div>


<script>
// Image preview
function previewImage() {
    const preview = document.getElementById('imagePreview');
    const file = document.getElementById('image_filename').files[0];
    if(file) {
        const reader = new FileReader();
        reader.onloadend = () => preview.src = reader.result;
        reader.readAsDataURL(file);
    }
}


// Shipping fee
function calculateShippingFee() {
    const weight = parseFloat(document.getElementsByName("weight")[0].value) || 0;
    const length = parseFloat(document.getElementsByName("packaging_length")[0].value) || 0;
    const width = parseFloat(document.getElementsByName("packaging_width")[0].value) || 0;
    const height = parseFloat(document.getElementsByName("packaging_height")[0].value) || 0;
    const volumetricWeight = (length*width*height)/5000;
    const fee = Math.max(weight, volumetricWeight)*50;
    document.getElementById("shipping_fee").value = fee.toFixed(2);
}
document.querySelectorAll("input[name='weight'], input[name='packaging_length'], input[name='packaging_width'], input[name='packaging_height']")
.forEach(i => i.addEventListener("input", calculateShippingFee));
window.onload = calculateShippingFee;


// Existing variation deletion
function removeExistingVariation(variationID){
    const form = document.querySelector('form');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'deleted_variations[]';
    input.value = variationID;
    form.appendChild(input);
    document.getElementById('variation-' + variationID).remove();
}


// Add new variation


   function addNewVariation() {
    var container = document.getElementById('new-variation-container');

    // Create the card container
    var card = document.createElement('div');
    card.className = 'variation-card'; // use global CSS class

    // Add inner HTML (no <style> tag)
    card.innerHTML = `
        <button type="button" class="delete-btn" onclick="removeVariation(this)">×</button>
        <div class="grid-row">
            <div>
                <label for="new_unit">Variant (e.g., Color, Type, Family, Size)</label>
                <input type="text" name="new_unit[]" placeholder="e.g., Red, Medium" required>
            </div>
            <div>
                <label for="new_price">Price</label>
                <input type="number" name="new_price[]" placeholder="0.00" required>
            </div>
            <div>
                <label for="new_quantity">Quantity</label>
                <input type="number" name="new_quantity[]" placeholder="0" required>
            </div>
        </div>
    `;

    container.appendChild(card);
}



// Address modal
function openAddressModal() {
    fetch('/get_seller_addresses')
    .then(res => res.json())
    .then(data => {
        let html = '';
        data.forEach(addr => {
            html += `<div
            style="padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:10px; cursor:pointer; transition: background-color 0.2s;"
            onmouseover="this.style.backgroundColor='#d4f8d4'"
            onmouseout="this.style.backgroundColor=''"
            onclick="chooseAddress('${addr.AddressID}')">
                <strong>${addr.Street}</strong><br>
                ${addr.Municipality}, ${addr.Province}<br>
                ${addr.Region}, ${addr.Zip_Code}
         </div>`;
        });
        document.getElementById('addressList').innerHTML = html;
        document.getElementById('addressModal').style.display = 'block';
    });
}
function closeAddressModal() { document.getElementById('addressModal').style.display='none'; }
function chooseAddress(addressID){
    fetch(`/update_product_address/{{ product['ProductID'] }}/${addressID}`, { method:'POST' })
    .then(res=>res.json())
    .then(data=>{
         if(data.success){
            // Close modal immediately
            closeAddressModal();


            Swal.fire({
                icon:"success",
                title:"Address Updated!",
                timer:1000,  // shorter duration
                showConfirmButton:false
            });


            // Reload after SweetAlert closes
            setTimeout(()=> location.reload(), 200);
        }
    });
}


// User dropdown
document.addEventListener('DOMContentLoaded', () => {
    const userIcon = document.getElementById('userIcon');
    const userMenu = document.getElementById('userMenu');
    userIcon.addEventListener('click', e => { userMenu.classList.toggle('show'); e.stopPropagation(); });
    document.addEventListener('click', e => { if(!userMenu.contains(e.target)) userMenu.classList.remove('show'); });
});
</script>
<script>
    function removeVariation(button) {
        const card = button.closest('.variation-card'); // find the parent card
        if (card) {
            card.remove(); // remove it from the DOM
        }
    }
</script>
</body>
</html>



